name: smoker

on:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # dependencies
      - name: Setup Go environment
        uses: actions/setup-go@v2-beta
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_ACTIONS_ASHTRAY }}

      # git setup
      - name: Setup repository
        run: |
          git config user.email "ashtray@davidepucci.it" 
          git config user.name "Smoker"

      # go dependencies
      - name: Install Go dependencies
        run: |
          go get -v github.com/streambinder/solbump
          echo "::add-path::$(go env GOPATH)/bin"
        env:
          GO111MODULE: on

      # solbump configuration
      - name: Configure Solbump
        run: |
          echo -e "github:\n    api: ${SOLBUMP_GITHUB_TOKEN}" > ${HOME}/.config/solbump
          echo -e "gitlab:\n    api: ${SOLBUMP_GITLAB_TOKEN}" >> ${HOME}/.config/solbump
        env:
          SOLBUMP_GITHUB_TOKEN: ${{ secrets.SOLBUMP_GITHUB_TOKEN }}
          SOLBUMP_GITLAB_TOKEN: ${{ secrets.SOLBUMP_GITLAB_TOKEN }}

      # effective action
      - name: Run packages update check
        run: |
          find src -name package.yml | while read fname; do
            ${HOME}/go/bin/solbump -verbose "${fname}"
            if ! git diff-index --quiet HEAD -- "${fname}"; then
              pkg_version="$(awk -F': ' '/^version/ {print $2}' "${fname}")"
              pkg_commit="$(sed 's|src/||g; s|/package.yml$||g; s|/|: |g' <<< "${fname}")"
              git commit -m "${pkg_commit}: update to ${pkg_version}" "${fname}"
            fi
          done
          git push
