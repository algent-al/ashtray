language: bash

globals:
    build_dir: bin

commands:

    setup:
        description: Prepare environment
        exec: mkdir -p ${build_dir}

    update:
        description: Update solbuild image
        exec: sudo solbuild update

    packages:
        description: Build all packages
        language: python3
        dependencies:
            - setup
            - update

    test:
        description: Test packages tree
        language: python3

    components:
        description: Build all components
        dependencies:
            - setup

    strip:
        description: Remove all non-up-to-date built packages

    index:
        description: Generate repository index
        exec: cd ${build_dir} && sudo solbuild index > /dev/null 2>&1

    release:
        description: Perform a full build
        dependencies:
            - packages
            - strip
            - index
            - components
        exec: echo -n

    fetch:
        description: Grab packages from latest release
        dependencies:
            - setup

    check:
        description: Check packages for updates
        exec: find src -type f -name 'package.yml' -exec solbump -dry {} \;

    gen-index:
        description: Generate packages index
        language: python3

    clean:
        description: Clean up
        exec: rm -rf ${build_dir}
